<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity History - CBE Career Guide</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #6366F1;
            --secondary: #F59E0B;
            --accent: #10B981;
            --success: #059669;
            --info: #0EA5E9;
            --warning: #F59E0B;
            --danger: #DC2626;
            --kenya-black: #000000;
            --kenya-red: #CE1126;
            --kenya-green: #006B3F;
            --kenya-white: #FFFFFF;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: url('https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=1920&h=1080&fit=crop&auto=format') center/cover fixed;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.9) 0%, rgba(16, 185, 129, 0.8) 50%, rgba(59, 130, 246, 0.9) 100%);
            z-index: -1;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }
        
        .gradient-kenya {
            background: linear-gradient(135deg, var(--kenya-green) 0%, var(--kenya-red) 50%, var(--kenya-black) 100%);
        }
        
        .navbar {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.95) !important;
            box-shadow: 0 1px 30px rgba(0, 0, 0, 0.1);
        }
        
        .history-card {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        
        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.2);
        }
        
        .activity-item {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .activity-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }
        
        .activity-item:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.15);
        }
        
        .activity-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .activity-icon.assessment {
            background: linear-gradient(135deg, var(--info) 0%, #3B82F6 100%);
            color: white;
        }
        
        .activity-icon.chat {
            background: linear-gradient(135deg, var(--accent) 0%, #14B8A6 100%);
            color: white;
        }
        
        .activity-icon.career {
            background: linear-gradient(135deg, var(--warning) 0%, #F97316 100%);
            color: white;
        }
        
        .activity-icon.scenario {
            background: linear-gradient(135deg, var(--danger) 0%, #EF4444 100%);
            color: white;
        }
        
        .filter-card {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .timeline-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 2rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: -2rem;
            width: 2px;
            background: linear-gradient(to bottom, var(--primary), var(--accent));
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: -4px;
            top: 1rem;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        
        .timeline-item:last-child::before {
            display: none;
        }
        
        .stats-overview {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #8B5CF6 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5B21B6 0%, var(--primary) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .kenya-flag {
            background: linear-gradient(to bottom, #000000 33.33%, #CE1126 33.33%, #CE1126 66.66%, #006B3F 66.66%);
            width: 24px;
            height: 18px;
            border-radius: 3px;
        }

        .footer {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }

        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- Navigation Header -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top border-bottom">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <div class="gradient-kenya rounded-3 me-3 p-2 shadow">
                    <i class="fas fa-graduation-cap text-white fs-5"></i>
                </div>
                <div>
                    <span class="fw-bold fs-4 text-primary">CBE Career Guide</span>
                    <div class="small text-muted d-none d-sm-block">
                        <div class="kenya-flag d-inline-block me-2"></div>
                        <span data-en="Ministry of Education Kenya" data-sw="Wizara ya Elimu Kenya">Ministry of Education Kenya</span>
                    </div>
                </div>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="chat.html">
                            <i class="fas fa-comments me-2"></i>AI Chat
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="assessment.html">
                            <i class="fas fa-clipboard-list me-2"></i>Assessment
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="pathways.html">
                            <i class="fas fa-route me-2"></i>Pathways
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="careers.html">
                            <i class="fas fa-briefcase me-2"></i>Careers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="scenarios.html">
                            <i class="fas fa-gamepad me-2"></i>Scenarios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="resources.html">
                            <i class="fas fa-book me-2"></i>Resources
                        </a>
                    </li>
                </ul>
                
                <div class="d-flex align-items-center">
                    <select id="languageSelect" onchange="changeLanguage()" class="form-select form-select-sm me-3" style="width: auto;">
                        <option value="en">ðŸ‡¬ðŸ‡§ English</option>
                        <option value="sw">ðŸ‡°ðŸ‡ª Kiswahili</option>
                    </select>
                    
                    <div id="authSection">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user me-1"></i>
                                <span id="userName">Student</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="profile.html">
                                    <i class="fas fa-user me-2"></i>Profile
                                </a></li>
                                <li><a class="dropdown-item" href="dashboard.html">
                                    <i class="fas fa-chart-line me-2"></i>Dashboard
                                </a></li>
                                <li><a class="dropdown-item active" href="history.html">
                                    <i class="fas fa-history me-2"></i>History
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="signOut()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Sign Out
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container py-4">
        
        <!-- Page Header -->
        <div class="text-center mb-5">
            <div class="history-card p-4 p-md-5">
                <div class="floating-animation d-inline-block mb-3">
                    <i class="fas fa-history text-primary" style="font-size: 3rem;"></i>
                </div>
                <h1 class="display-5 fw-bold mb-3">
                    <span data-en="Activity History" data-sw="Historia ya Shughuli">Activity History</span>
                </h1>
                <p class="lead text-muted">
                    <span data-en="Track your learning journey and career exploration progress" data-sw="Fuatilia safari yako ya kujifunza na maendeleo ya uchunguzi wa kazi">Track your learning journey and career exploration progress</span>
                </p>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-overview fade-in">
            <h3 class="fw-bold mb-4 text-center">
                <span data-en="Your Progress Overview" data-sw="Muhtasari wa Maendeleo Yako">Your Progress Overview</span>
            </h3>
            <div class="row g-4">
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <i class="fas fa-clipboard-list text-info fs-2 mb-2"></i>
                        <h4 class="text-primary mb-1" id="totalAssessments">5</h4>
                        <small class="text-muted">
                            <span data-en="Assessments" data-sw="Tathmini">Assessments</span>
                        </small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <i class="fas fa-comments text-success fs-2 mb-2"></i>
                        <h4 class="text-primary mb-1" id="totalChats">23</h4>
                        <small class="text-muted">
                            <span data-en="AI Chats" data-sw="Mazungumzo ya AI">AI Chats</span>
                        </small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <i class="fas fa-briefcase text-warning fs-2 mb-2"></i>
                        <h4 class="text-primary mb-1" id="totalCareers">12</h4>
                        <small class="text-muted">
                            <span data-en="Careers Explored" data-sw="Kazi Zilichunguzwa">Careers Explored</span>
                        </small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <i class="fas fa-gamepad text-danger fs-2 mb-2"></i>
                        <h4 class="text-primary mb-1" id="totalScenarios">8</h4>
                        <small class="text-muted">
                            <span data-en="Scenarios Completed" data-sw="Hali Zilizokamilika">Scenarios Completed</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Filters -->
            <div class="col-lg-4">
                <div class="filter-card p-4">
                    <h4 class="fw-bold mb-4">
                        <i class="fas fa-filter me-2 text-primary"></i>
                        <span data-en="Filter Activities" data-sw="Chuja Shughuli">Filter Activities</span>
                    </h4>
                    
                    <!-- Date Range -->
                    <div class="mb-3">
                        <label class="form-label fw-medium">
                            <span data-en="Date Range" data-sw="Kipindi cha Tarehe">Date Range</span>
                        </label>
                        <select id="dateFilter" class="form-select" onchange="filterActivities()">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    
                    <!-- Activity Type -->
                    <div class="mb-3">
                        <label class="form-label fw-medium">
                            <span data-en="Activity Type" data-sw="Aina ya Shughuli">Activity Type</span>
                        </label>
                        <select id="typeFilter" class="form-select" onchange="filterActivities()">
                            <option value="all">All Activities</option>
                            <option value="assessment">Assessments</option>
                            <option value="chat">AI Chats</option>
                            <option value="career">Career Explorations</option>
                            <option value="scenario">Scenarios</option>
                            <option value="resource">Resources</option>
                        </select>
                    </div>
                    
                    <!-- Search -->
                    <div class="mb-4">
                        <label class="form-label fw-medium">
                            <span data-en="Search" data-sw="Tafuta">Search</span>
                        </label>
                        <input type="text" id="searchFilter" class="form-control" placeholder="Search activities..." oninput="filterActivities()">
                    </div>
                    
                    <!-- Export Options -->
                    <div class="d-grid gap-2">
                        <button onclick="exportHistory()" class="btn btn-outline-primary">
                            <i class="fas fa-download me-2"></i>
                            <span data-en="Export History" data-sw="Hamisha Historia">Export History</span>
                        </button>
                        <button onclick="clearHistory()" class="btn btn-outline-danger">
                            <i class="fas fa-trash me-2"></i>
                            <span data-en="Clear History" data-sw="Futa Historia">Clear History</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Activity Timeline -->
            <div class="col-lg-8">
                <div class="history-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold mb-0">
                            <i class="fas fa-timeline me-2 text-primary"></i>
                            <span data-en="Activity Timeline" data-sw="Ratiba ya Shughuli">Activity Timeline</span>
                        </h4>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" onclick="toggleView('timeline')">
                                <i class="fas fa-list me-1"></i>Timeline
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="toggleView('grid')">
                                <i class="fas fa-th me-1"></i>Grid
                            </button>
                        </div>
                    </div>
                    
                    <!-- Timeline View -->
                    <div id="timelineView" class="timeline-container">
                        <div id="activitiesList">
                            <!-- Activities will be populated by JavaScript -->
                        </div>
                        
                        <!-- Load More Button -->
                        <div class="text-center mt-4">
                            <button id="loadMoreBtn" onclick="loadMoreActivities()" class="btn btn-outline-primary">
                                <i class="fas fa-plus me-2"></i>
                                <span data-en="Load More" data-sw="Pakia Zaidi">Load More</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Grid View -->
                    <div id="gridView" class="d-none">
                        <div id="activitiesGrid" class="row g-3">
                            <!-- Grid items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Activity Detail Modal -->
    <div class="modal fade" id="activityModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">
                        <span data-en="Activity Details" data-sw="Maelezo ya Shughuli">Activity Details</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="activityModalContent">
                    <!-- Activity details will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer text-white py-4 mt-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start mb-2 mb-md-0">
                    <p class="mb-0 small text-light-emphasis">
                        Â© 2025 CBE Career Guide. All rights reserved.
                    </p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <p class="mb-0 small fw-medium">
                        Developed by <span class="text-warning fw-bold">Code Champ</span> 2025
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let allActivities = [];
        let filteredActivities = [];
        let displayedActivities = 0;
        const activitiesPerPage = 10;
        let currentView = 'timeline';

        // Sample activity data
        const sampleActivities = [
            {
                id: 1,
                type: 'assessment',
                title: 'Career Assessment Completed',
                description: 'Completed comprehensive career assessment - STEM pathway recommended',
                timestamp: '2025-01-15T10:30:00Z',
                data: { pathway: 'STEM', score: 85 }
            },
            {
                id: 2,
                type: 'chat',
                title: 'AI Chat Session',
                description: 'Discussed STEM career opportunities and university requirements',
                timestamp: '2025-01-15T11:15:00Z',
                data: { messages: 8, topic: 'STEM careers' }
            },
            {
                id: 3,
                type: 'career',
                title: 'Career Exploration',
                description: 'Explored Software Developer career details',
                timestamp: '2025-01-14T14:20:00Z',
                data: { career: 'Software Developer', pathway: 'STEM' }
            },
            {
                id: 4,
                type: 'scenario',
                title: 'Scenario Completed',
                description: 'Completed "Software Development Challenge" scenario',
                timestamp: '2025-01-14T16:45:00Z',
                data: { scenario: 'Software Development Challenge', score: 92 }
            },
            {
                id: 5,
                type: 'resource',
                title: 'Resource Viewed',
                description: 'Downloaded University Application Guide',
                timestamp: '2025-01-13T09:10:00Z',
                data: { resource: 'University Application Guide' }
            }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthState();
            loadActivities();
            initializeLanguage();
        });

        async function checkAuthState() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('userName').textContent = currentUser.user_metadata?.full_name || 'Student';
                await loadUserActivities();
            } else {
                window.location.href = 'login.html';
            }
        }

        async function loadUserActivities() {
            try {
                // In a real app, load from Supabase
                // const { data: activities } = await supabase.from('user_activities').select('*');
                
                // For demo, use sample data
                allActivities = [...sampleActivities];
                filteredActivities = [...allActivities];
                displayActivities();
                updateStats();
            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        function loadActivities() {
            // Generate more sample activities for demo
            const activityTypes = ['assessment', 'chat', 'career', 'scenario', 'resource'];
            const titles = {
                assessment: ['Career Assessment Completed', 'Pathway Assessment Taken', 'Skills Assessment Finished'],
                chat: ['AI Chat Session', 'Career Guidance Chat', 'Pathway Discussion'],
                career: ['Career Exploration', 'Job Details Viewed', 'Salary Information Checked'],
                scenario: ['Scenario Completed', 'Challenge Finished', 'Interactive Simulation'],
                resource: ['Resource Downloaded', 'Guide Viewed', 'Document Accessed']
            };

            for (let i = 6; i <= 50; i++) {
                const type = activityTypes[Math.floor(Math.random() * activityTypes.length)];
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                
                allActivities.push({
                    id: i,
                    type: type,
                    title: titles[type][Math.floor(Math.random() * titles[type].length)],
                    description: `Activity description for ${type} activity`,
                    timestamp: date.toISOString(),
                    data: { score: Math.floor(Math.random() * 100) }
                });
            }

            filteredActivities = [...allActivities];
            displayActivities();
            updateStats();
        }

        function displayActivities() {
            const container = document.getElementById('activitiesList');
            const startIndex = displayedActivities;
            const endIndex = Math.min(startIndex + activitiesPerPage, filteredActivities.length);

            for (let i = startIndex; i < endIndex; i++) {
                const activity = filteredActivities[i];
                const activityElement = createActivityElement(activity);
                container.appendChild(activityElement);
            }

            displayedActivities = endIndex;

            // Hide load more button if all activities are displayed
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (displayedActivities >= filteredActivities.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'block';
            }
        }

        function createActivityElement(activity) {
            const div = document.createElement('div');
            div.className = 'timeline-item fade-in';
            
            const iconClass = getActivityIcon(activity.type);
            const timeAgo = getTimeAgo(activity.timestamp);
            
            div.innerHTML = `
                <div class="activity-item" onclick="showActivityDetails(${activity.id})">
                    <div class="d-flex align-items-start">
                        <div class="activity-icon ${activity.type}">
                            <i class="${iconClass}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="fw-bold mb-1">${activity.title}</h6>
                                <small class="text-muted">${timeAgo}</small>
                            </div>
                            <p class="text-muted mb-2">${activity.description}</p>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-${getActivityColor(activity.type)} bg-opacity-20 text-${getActivityColor(activity.type)} me-2">
                                    ${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)}
                                </span>
                                ${activity.data.score ? `<span class="small text-success"><i class="fas fa-star me-1"></i>${activity.data.score}%</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        function getActivityIcon(type) {
            const icons = {
                assessment: 'fas fa-clipboard-list',
                chat: 'fas fa-comments',
                career: 'fas fa-briefcase',
                scenario: 'fas fa-gamepad',
                resource: 'fas fa-book'
            };
            return icons[type] || 'fas fa-circle';
        }

        function getActivityColor(type) {
            const colors = {
                assessment: 'info',
                chat: 'success',
                career: 'warning',
                scenario: 'danger',
                resource: 'primary'
            };
            return colors[type] || 'secondary';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return time.toLocaleDateString();
        }

        function updateStats() {
            const stats = {
                assessment: 0,
                chat: 0,
                career: 0,
                scenario: 0
            };

            allActivities.forEach(activity => {
                if (stats.hasOwnProperty(activity.type)) {
                    stats[activity.type]++;
                }
            });

            document.getElementById('totalAssessments').textContent = stats.assessment;
            document.getElementById('totalChats').textContent = stats.chat;
            document.getElementById('totalCareers').textContent = stats.career;
            document.getElementById('totalScenarios').textContent = stats.scenario;
        }

        function filterActivities() {
            const dateFilter = document.getElementById('dateFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredActivities = allActivities.filter(activity => {
                // Date filter
                if (dateFilter !== 'all') {
                    const activityDate = new Date(activity.timestamp);
                    const now = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            if (activityDate.toDateString() !== now.toDateString()) return false;
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            if (activityDate < weekAgo) return false;
                            break;
                        case 'month':
                            if (activityDate.getMonth() !== now.getMonth()) return false;
                            break;
                        case 'year':
                            if (activityDate.getFullYear() !== now.getFullYear()) return false;
                            break;
                    }
                }

                // Type filter
                if (typeFilter !== 'all' && activity.type !== typeFilter) return false;

                // Search filter
                if (searchFilter && !activity.title.toLowerCase().includes(searchFilter) && 
                    !activity.description.toLowerCase().includes(searchFilter)) return false;

                return true;
            });

            // Clear and reload activities
            document.getElementById('activitiesList').innerHTML = '';
            displayedActivities = 0;
            displayActivities();
        }

        function loadMoreActivities() {
            displayActivities();
        }

        function toggleView(view) {
            currentView = view;
            const timelineView = document.getElementById('timelineView');
            const gridView = document.getElementById('gridView');
            const buttons = document.querySelectorAll('.btn-group button');

            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (view === 'timeline') {
                timelineView.classList.remove('d-none');
                gridView.classList.add('d-none');
                buttons[0].classList.add('active');
            } else {
                timelineView.classList.add('d-none');
                gridView.classList.remove('d-none');
                buttons[1].classList.add('active');
                loadGridView();
            }
        }

        function loadGridView() {
            const container = document.getElementById('activitiesGrid');
            container.innerHTML = '';

            filteredActivities.slice(0, displayedActivities).forEach(activity => {
                const div = document.createElement('div');
                div.className = 'col-md-6 col-lg-4';
                div.innerHTML = `
                    <div class="activity-item h-100" onclick="showActivityDetails(${activity.id})">
                        <div class="text-center">
                            <div class="activity-icon ${activity.type} mx-auto mb-3">
                                <i class="${getActivityIcon(activity.type)}"></i>
                            </div>
                            <h6 class="fw-bold">${activity.title}</h6>
                            <p class="small text-muted">${activity.description}</p>
                            <span class="badge bg-${getActivityColor(activity.type)}">${activity.type}</span>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function showActivityDetails(activityId) {
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity) return;

            const modalContent = document.getElementById('activityModalContent');
            modalContent.innerHTML = `
                <div class="text-center mb-4">
                    <div class="activity-icon ${activity.type} mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                        <i class="${getActivityIcon(activity.type)}"></i>
                    </div>
                    <h4 class="fw-bold">${activity.title}</h4>
                    <p class="text-muted">${new Date(activity.timestamp).toLocaleString()}</p>
                </div>
                
                <div class="card border-0 bg-light mb-3">
                    <div class="card-body">
                        <h6 class="fw-bold">Description</h6>
                        <p class="mb-0">${activity.description}</p>
                    </div>
                </div>
                
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="fw-bold">Activity Data</h6>
                        <pre class="mb-0">${JSON.stringify(activity.data, null, 2)}</pre>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('activityModal'));
            modal.show();
        }

        function exportHistory() {
            const data = {
                user: currentUser?.email || 'student',
                export_date: new Date().toISOString(),
                total_activities: allActivities.length,
                activities: filteredActivities
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `cbe_activity_history_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showSuccessMessage('Activity history exported successfully!');
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all activity history? This action cannot be undone.')) {
                allActivities = [];
                filteredActivities = [];
                document.getElementById('activitiesList').innerHTML = '';
                document.getElementById('activitiesGrid').innerHTML = '';
                updateStats();
                showSuccessMessage('Activity history cleared successfully!');
            }
        }

        async function signOut() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        function initializeLanguage() {
            const savedLanguage = localStorage.getItem('selectedLanguage') || 'en';
            document.getElementById('languageSelect').value = savedLanguage;
            changeLanguage();
        }

        function changeLanguage() {
            const select = document.getElementById('languageSelect');
            const currentLanguage = select.value;
            localStorage.setItem('selectedLanguage', currentLanguage);
            
            document.querySelectorAll('[data-en]').forEach(element => {
                if (currentLanguage === 'en') {
                    element.textContent = element.getAttribute('data-en');
                } else {
                    element.textContent = element.getAttribute('data-sw');
                }
            });
        }

        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 p-3';
            toast.style.zIndex = '1050';
            toast.innerHTML = `
                <div class="toast align-items-center text-white bg-success border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-check-circle me-2"></i>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast.querySelector('.toast'));
            bsToast.show();
            
            setTimeout(() => toast.remove(), 3000);
        }
    </script>

</body>
</html>
